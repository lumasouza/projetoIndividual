<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="stylesheet" href="./telaCha.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dashboard | cházim?</title>
</head>

<style>
    .cha {
        width: 13vh;
        border-radius: 15vh;
    }

    .contFavoritos {
        color: whitesmoke;
        display: flex;
        flex-wrap: wrap;
        text-align: center;
        /* justify-content: center; */
        align-items: center;
    }

    .chaFav {
        margin: 2vh 2vh 0vh 2vh;
    }
</style>

<body onload="recuperarFavoritos(), visualizarConsumo()">
    <!-- NAVBAR -->
    <div class="header">
        <div class="nav">
            <img id="imgLogo" src="assets/logoChazim2.png">
            <ul class="navbar">
                <li><a href="index.html">Home</a></li>
                <li><a class="login" href="telaLogin.html">Login</a></li>
                <li><a class="cad" href="telaCadastro.html">Cadastre-se</a></li>
            </ul>
        </div>
    </div>
    <!-- NAVBAR -->

    <!-- CHÁS FAVORITOS -->

    <div class="container">

        <div class="conteudo">

            <div class="pesquisa">

                <div id="divUsuario" class="subtitulo">Olá, Usuário!</div>

                <div class="subtitulo" style="text-align: start;">Seus chás favoritos</div>

                <div id="divFavoritos" class="contFavoritos">
                    <!-- vindo do fetch -->
                </div>

            </div>

            <div class="subtitulo" style="text-align: start;">
                <input id="iptAddChaFav" type="text" placeholder="Adicione um novo chá favorito">
                <!-- vindo do fetch -->
                <button onclick="procurarCha()">Adicionar</button>
            </div>
            <div id="divMsgErroFav" style="text-align: start;"></div>

        </div>

    </div>


    <div class="container">

        <div class="conteudo">

            <!-- <div class="titulo">Registrar consumo</div> -->
            <div class="subtitulo">Registrar consumo</div>

            <div class="texto">
                <input class="inputRegistro" type="text" id="iptChaReg" placeholder="Insira o chá" onblur="">
                <input class="inputRegistro" type="number" id="iptXicarasReg" placeholder="Quantidade de xícaras">
                <input class="inputRegistro" type="date" id="iptDataReg" placeholder="Data">
                <button onclick="registrarConsumo()">Registrar consumo</button>
            </div>

            <div id="divMsgReg" style="text-align: center; margin-bottom: 2vh;"></div>

            <div class="subtitulo">Últimos consumos registrados</div>
            <div id="divRegistro" style="text-align: start;">

            </div>

        </div>

    </div>

    <div class="container">

        <div class="conteudo">

            <!-- <div class="titulo">Registrar consumo</div> -->
            <div class="subtitulo">Gráficos</div>

            <div class="">
                <div style="display: flex;">

                    <div>Acompanhe seus últimos consumos</div>
                    <div>
                        <canvas id="myChart" style="position: relative; height: 30vh; width: 35vw;"></canvas>
                    </div>

                </div>

                <div style="display: flex;">

                    <div>Seus chás mais bebidos</div>
                    <div>
                        <canvas id="myChart2" style="position: relative; height: 25vh; width: 25vw;"></canvas>
                    </div>

                </div>
                <!-- <input class="inputRegistro" type="text" id="iptCha" placeholder="Chá"> <input class="inputRegistro"
                    type="text" id="iptXicaras" placeholder="Quantidade de xícaras"> <input class="inputRegistro"
                    type="date" id="iptData" placeholder="Data">
                    <button onclick="registrarConsumo()">Registrar consumo</button> -->
            </div>

        </div>

    </div>

    <footer>



    </footer>

</body>

</html>

<script>
    var nomeUsuario = sessionStorage.NOME_USUARIO;
    var idUsuario = sessionStorage.ID_USUARIO;
    var listaCha = []

    divUsuario.innerHTML = `Olá, ${nomeUsuario}!`

    // Recuperando chás favoritos do usuário
    function recuperarFavoritos() {
        divFavoritos.innerHTML = ""

        fetch("/cha/listarFavoritos", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                fkUsuarioServer: idUsuario
            })
        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {

                resposta.json().then(json => {
                    // console.log(json);
                    console.log('Resposta listarFavoritos: ', JSON.stringify(json));

                    for (var i = 0; i < json.length; i++) {
                        var favAtual = json[i];
                        listaCha.push(favAtual.nome);
                        divFavoritos.innerHTML += `<div class="chaFav">
                            <div><img class="cha" src="${favAtual.imagem}" alt=""></div>
                            <div>${favAtual.nome}</div>
                        </div>`
                    }

                });

            } else {
                throw ("Erro de recuperação de favoritos");
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    // Adicionando novos chás aos favoritos
    function procurarCha() {
        var nomeCha = iptAddChaFav.value;

        if (nomeCha == '') {
            divMsgErroFav.innerHTML = "Campo vazio! Por favor, verifique e tente novamente"
        } else {
            fetch("/cha/listarCha", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    nomeChaServer: nomeCha
                })
            }).then(function (resposta) {

                console.log("resposta: ", resposta);

                if (resposta.ok) {

                    resposta.json().then(json => {

                        //alguma coisa aqui.... não vai dar pra reusar a função
                        if (json.length > 0) {
                            if (listaCha.indexOf(json[0].nome) > -1) {
                                divMsgErroFav.innerHTML = "Você já possui este chá em sua lista!";
                                return
                            } else {

                                var idCha = json[0].id;

                                fetch("/cha/addFavorito", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json"
                                    },
                                    body: JSON.stringify({
                                        fkChaServer: idCha,
                                        fkUsuarioServer: idUsuario
                                    })
                                }).then(function (resposta) {

                                    console.log("resposta: ", resposta);

                                    if (resposta.ok) {
                                        divMsgErroFav.innerHTML = "Chá adicionado aos favoritos"
                                        recuperarFavoritos()
                                        setTimeout(() => {
                                            divMsgErroFav.innerHTML = "";
                                        }, "5000")
                                    } else {
                                        throw ("Houve um erro ao tentar realizar o cadastro!");
                                    }
                                }).catch(function (resposta) {
                                    console.log(`#ERRO: ${resposta}`);
                                    // finalizarAguardar();
                                });

                                return false;
                            }
                        } else {
                            divMsgErroFav.innerHTML = "O chá não foi encontrado em nossa base de dados"
                        }
                    });

                } else {
                    throw ("Houve um erro ao tentar realizar o cadastro!");
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });

            return false;
        }
    }

    // Registrando o consumo de chás em um determinado dia
    function registrarConsumo() {
        var chaReg = iptChaReg.value;
        var xicarasReg = Number(iptXicarasReg.value);
        var dataReg = iptDataReg.value;

        if (chaReg == '' || xicarasReg == 0 || dataReg == "") {
            divMsgReg.innerHTML = "Campo vazio! Por favor, verifique e tente novamente"
        } else {
            fetch("/cha/listarCha", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    nomeChaServer: chaReg
                })
            }).then(function (resposta) {

                console.log("resposta: ", resposta);

                if (resposta.ok) {

                    resposta.json().then(json => {
                        console.log('resposta do fetch do registro: ', json)

                        if (json.length > 0) {
                            var idCha = json[0].id;

                            //FETCH INSERIR DADOS   
                            fetch("/cha/registrarConsumo", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({
                                    fkUsuarioServer: idUsuario,
                                    fkChaServer: idCha,
                                    qntdServer: xicarasReg,
                                    dtConsumoServer: dataReg
                                })
                            }).then(function (resposta) {

                                console.log("resposta: ", resposta);

                                if (resposta.ok) {
                                    divMsgReg.innerHTML = "Registro adicionado com sucesso"
                                    iptChaReg.value = ""
                                    iptDataReg.value = ""
                                    iptXicarasReg.value = 0
                                    visualizarConsumo()
                                    // recuperarFavoritos()
                                    // setTimeout(() => {
                                    //     divMsgErroFav.innerHTML = "";
                                    // }, "5000")
                                } else {
                                    alert("algo deu errado :(")
                                    throw ("Houve um erro ao tentar realizar o cadastro!");
                                }
                            }).catch(function (resposta) {
                                console.log(`#ERRO: ${resposta}`);
                                // finalizarAguardar();
                            });

                            return false;

                        } else {
                            divMsgReg.innerHTML = "O chá não foi encontrado em nossa base de dados"
                        }
                    });

                } else {
                    throw ("Houve um erro ao tentar realizar o cadastro!");
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });

            return false;
        }
    }

    function visualizarConsumo() {
        divRegistro.innerHTML = `<div class="linha" >
                    <div class="registro" style="background-color: darksalmon;">Nome do chá</div>
                    <div class="registro" style="background-color: darksalmon;">Quantidade de xícaras</div>
                    <div class="registro" style="background-color: darksalmon;">Data do Consumo</div>
                </div>`

        fetch("/cha/visualizarConsumo", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                fkUsuarioServer: idUsuario
            })
        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {

                resposta.json().then(json => {
                    // console.log(json);
                    console.log('Resposta visualizarConsumo: ', JSON.stringify(json));
                    // alert("entrei no visualizarConsumo!!!")

                    for (var i = 0 ; i < json.length ; i++) {
                        divRegistro.innerHTML += `<div class="linha">
                    <div class="registro">${json[i].nome}</div>
                    <div class="registro">${json[i].qntd}</div>
                    <div class="registro">${json[i].dtConsumo}</div>
                </div>`
                    }

                });

            } else {
                throw ("Erro de recuperação de favoritos");
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }
    // Recuperar chás já existentes de uma lista
    // var listaCha = ['Camomila', 'Erva doce', 'Hortelã', 'Melissa'];

    // for (var i = 0; i < listaCha.length; i++) {
    //     const chaAtual = listaCha[i];
    //     divChasFav.innerHTML += `<li> ${chaAtual} </li>`
    // }

    // Adicionar novo chá - verificar se já existe na lista
    function addChaFav() {
        var novoCha = iptAddChaFav.value;
        var naoExisteCha = false;

        // if (listaCha.indexOf(novoCha) > -1) {
        //     listaCha.push(novoCha);
        //     divChasFav.innerHTML += `<li> ${listaCha[listaCha.length - 1]} </li>`
        // } else {
        //     alert("Chá já existe na lista");
        // }

        for (var i = 0; i < listaCha.length; i++) {
            const chaAtual = listaCha[i];
            if (novoCha.toLowerCase() == chaAtual.toLowerCase()) {
                alert("Chá já existe na lista");
                var naoExisteCha = true;
            }
        }

        if (naoExisteCha == false) {
            listaCha.push(novoCha);
            divChasFav.innerHTML += `<li> ${listaCha[listaCha.length - 1]} </li>`
        }
    }

    // Registrar consumo de um chá
    function registrarConsumo2() {
        var cha = iptCha.value;
        var xicaras = Number(iptXicaras.value);
        var data = iptData.value;

        divRegistro.innerHTML += `<div> Chá: ${cha} - Xícaras: ${xicaras} - Data: ${data} </div>`
    }
</script>


<!-- CHART JS -->
<script>
    // GRÁFICO DIÁRIO
    Chart.defaults.color = '#FFFFFF';

    const labels = [
        '18/05/2023',
        '19/05/2023',
        '22/05/2023',
        '23/05/2023',
        '28/05/2023',
        '29/05/2023',
        '31/05/2023',
    ];

    const data = {
        labels: labels,
        datasets: [{
            label: "Quantidade de xícaras",
            backgroundColor: "rgb(255, 127, 39)",
            borderColor: "rgb(255, 127, 39)",
            data: [3, 2, 5, 1, 4, 2, 4]
        }]
    };

    const config = {
        type: `line`,
        data: data,
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    };

    const myChart = new Chart(
        document.getElementById('myChart'),
        config
    )

    // GRÁFICO TOTAL
    const labels2 = [
        'Capim limão',
        'Camomila',
        'Hortelã',
        'Erva doce',
    ];

    const data2 = {
        labels: labels2,
        datasets: [{
            label: "Quantidade de xícaras",
            backgroundColor: [
                "rgb(255, 127, 39)",
                "rgb(0, 127, 39)",
                "rgb(50, 201, 58)",
                "rgb(130, 70, 150)",

            ],
            borderColor: "transparent",
            data: [3.7, 1.9, 2.5, 0.7]
        }]
    };

    const config2 = {
        type: `doughnut`,
        data: data2,
        options: {
            plugins: {
                legend: {
                    position: 'right'
                }
            }
            // scales: {
            //     y: {
            //         beginAtZero: true,
            //         ticks: {
            //             stepSize: 1
            //         }
            //     }
            // }
        }
    };

    const myChart2 = new Chart(
        document.getElementById('myChart2'),
        config2
    )
</script>